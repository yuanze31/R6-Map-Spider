name: R6 Maps 自动爬取

# 触发条件：每8小时执行 + 手动触发
on:
  schedule:
    - cron: "0 */8 * * *"  # 每8小时整点执行
  workflow_dispatch:       # 手动触发按钮

jobs:
  crawl-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 授予创建release的权限

    steps:
      # 1. 检出代码
      - name: 检出仓库代码
        uses: actions/checkout@v4

      # 2. 配置Python环境
      - name: 设置Python环境
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 3. 安装依赖（包括Chrome浏览器）
      - name: 安装系统依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver
          sudo ln -s /usr/bin/chromedriver /usr/local/bin/chromedriver

      # 4. 安装Python依赖
      - name: 安装Python包
        run: |
          python -m pip install --upgrade pip
          pip install requests selenium

      # 5. 运行爬取脚本（允许出错，以便后续上传调试文件）
      - name: 执行爬取脚本
        run: python main.py
        id: crawler
        continue-on-error: true

      # 6. 读取当前哈希值（仅当脚本成功时执行）
      - name: 获取当前文件哈希
        if: steps.crawler.outcome == 'success'  # 仅成功时读取
        id: get_current_hash
        run: |
          CURRENT_HASH=$(cat ./hash.txt)
          echo "current_hash=$CURRENT_HASH" >> $GITHUB_OUTPUT

      # 7. 获取上一次Release的哈希值
      - name: 获取历史哈希值
        id: get_last_hash
        run: |
          # 尝试获取最新release的哈希（body中查找）
          LAST_HASH=$(gh release view --json body -q '.body | split("\n") | map(select(startswith("哈希值: "))) | .[0] | split(" ")[1]' 2>/dev/null || echo "")
          echo "last_hash=$LAST_HASH" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 8. 对比哈希值，不一致则创建新Release
      - name: 创建新Release（哈希不同时）
        if: steps.get_current_hash.outputs.current_hash != steps.get_last_hash.outputs.last_hash
        run: |
          # 生成合法的版本号（用连字符替换斜杠和空格，避免特殊字符）
          VERSION=$(date +"%Y-%m-%d-%H-%M-%S")
          # 创建Release并上传文件（tag_name使用合法格式的VERSION）
          gh release create \
            "$VERSION" \
            ./r6maps.zip \
            --title "$(date +"%Y/%m/%d %H:%M:%S")" \
            --notes "哈希值: ${{ steps.get_current_hash.outputs.current_hash }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}